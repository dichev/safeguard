#!/usr/bin/env node

'use strict';

const program = require('commander')
const sleep = require('../src/lib/Utils').sleep
const Safeguard = require('../src/SafeGuard')
const Server = require('../src/Server')

const THROTTLE = require('../src/config/Config').schedule.initialThrottleBetweenOperators
const OPERATORS = Object.keys(require('../src/config/Config').credentials.databases.operators)


program
    .option('-o, --operators <operators>', `Comma-separated list on which operators to be executed. Available: ${OPERATORS}. Default: all `)
    // .option('-m, --mode <parallel|sequential>', `Run multiple operators in parallel or one by one. Default: parallel `)
    .option('-v, --verbose', 'Display error stack trace')
    .option('--clean', `Fresh start - will clean the safeguard database logs and alerts`)
    .option('--no-server', `Normally the safeguard expose http server, to provide prometheus metrics. This will disable it`)
    
    .version(require('../package.json').version)
    .parse(process.argv)



;(async function () {
    
    let server = null
    if(program.server) {
        server = new Server()
        server.listen()
    }
    
    if(program.clean) await Safeguard.cleanDatabase()
    // let parallel = program.mode !== 'sequential'
    let operators = program.operators && program.operators !== 'all' ? program.operators.split(',') : OPERATORS
    let guards = []
    for (let operator of operators) {
        let guard = new Safeguard(operator)
        if(server) server.addMetrics(() => guard.metrics())
        guards.push(guard)
    }
    // run in parallel
    await Promise.all(guards.map(async (guard, i) => {
        await sleep(i * THROTTLE) // throttle db connections
        await guard.activate()
    }))
})()
.catch(err  => {
    program.verbose ? console.error(err.stack) : console.error(err.message || err)
    process.exit(1)
})


